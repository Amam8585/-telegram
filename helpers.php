<?php
function api($m,$p,$multi=false){$ch=curl_init();curl_setopt_array($ch,[CURLOPT_URL=>'https://api.telegram.org/bot'.BOT_TOKEN.'/'.$m,CURLOPT_POST=>true,CURLOPT_RETURNTRANSFER=>true,CURLOPT_POSTFIELDS=>$p]);if($multi){curl_setopt($ch,CURLOPT_HTTPHEADER,[]);} $r=curl_exec($ch);curl_close($ch);return json_decode($r,true);}
function data_dir(){return __DIR__.'/data';}
function ensure_dir(){if(!is_dir(data_dir()))@mkdir(data_dir(),0775,true);}
function st_path($cid){ensure_dir();return data_dir().'/plan_'.$cid.'.json';}
function ust_path($uid){ensure_dir();return data_dir().'/user_'.$uid.'.json';}
function load_state($cid){$p=st_path($cid);if(file_exists($p)){$j=file_get_contents($p);$a=json_decode($j,true);if(is_array($a))return $a;}return null;}
function save_state($cid,$a){file_put_contents(st_path($cid),json_encode($a,JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),LOCK_EX);}
function del_state($cid){$p=st_path($cid);if(file_exists($p))@unlink($p);}
function load_uctx($uid){$p=ust_path($uid);if(file_exists($p)){$j=file_get_contents($p);$a=json_decode($j,true);if(is_array($a))return $a;}return null;}
function save_uctx($uid,$a){file_put_contents(ust_path($uid),json_encode($a,JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),LOCK_EX);}
function list_plan_files(){ensure_dir();$g=glob(data_dir().'/plan_*.json');return $g?$g:[];}
function label_tick($on,$txt){return ($on?'✅ ':'⬜ ').$txt;}
function rules_kb($st,$uid,$locked=false){global $BTN;$kyc=$st['kyc']??[];$on_act=in_array('act',$kyc);$on_fb=in_array('fb',$kyc);$on_gg=in_array('gg',$kyc);$kyc_on=(bool)($st['kyc_on']??false);$misc_on=(bool)($st['misc_on']??false);$ack_on=isset(($st['acks']??[])[$uid]);$cb=function($x)use($locked){return $locked?'lock':$x;};$rows=[];if(!$misc_on){$rows[]=[['text'=>label_tick($on_gg,$BTN['google']),'callback_data'=>$cb('tgl_gg')],['text'=>label_tick($on_fb,$BTN['facebook']),'callback_data'=>$cb('tgl_fb')],['text'=>label_tick($on_act,$BTN['activision']),'callback_data'=>$cb('tgl_act')]];}$rows[]=[['text'=>($kyc_on?$BTN['kyc_on']:$BTN['kyc_off']),'callback_data'=>$cb('tgl_kyc')],['text'=>($misc_on?$BTN['misc_on']:$BTN['misc_off']),'callback_data'=>$cb('tgl_misc')]];$rows[]=[['text'=>($ack_on?$BTN['ack_me_on']:$BTN['ack_me_off']),'callback_data'=>$cb('ack_go')]];return ['inline_keyboard'=>$rows];}
function fbq_kb($locked=false){global $BTN;$cb=function($x)use($locked){return $locked?'lock':$x;};return ['inline_keyboard'=>[[['text'=>$BTN['fbchg_on'],'callback_data'=>$cb('fbchg_on')],['text'=>$BTN['fbchg_off'],'callback_data'=>$cb('fbchg_off')]]]];}
function method_kb(){global $BTN;return ['inline_keyboard'=>[[['text'=>$BTN['m_auto'],'callback_data'=>'m_auto'],['text'=>$BTN['m_card'],'callback_data'=>'m_card']]]];}
function need_fb_question($st){$a=$st['kyc']??[];$hasAct=in_array('act',$a);$hasFb=in_array('fb',$a);$hasGg=in_array('gg',$a);return ($hasAct&&$hasFb)||($hasAct&&$hasGg)||($hasGg&&$hasFb&&!$hasAct);}
function compute_fee($amount){if($amount<0)$amount=0;$k=1000;$mm=1000000;$r=[[0,400*$k,15000],[400*$k,900*$k,20000],[900*$k,1.5*$mm,25000],[1.5*$mm,2*$mm,30000],[2*$mm,2.5*$mm,40000],[2.5*$mm,3*$mm,60000],[3*$mm,3.5*$mm,70000],[3.5*$mm,4*$mm,80000],[4*$mm,4.5*$mm,90000],[4.5*$mm,5*$mm,110000],[5*$mm,5.5*$mm,120000],[5.5*$mm,6*$mm,140000],[6*$mm,6.5*$mm,160000],[6.5*$mm,7*$mm,185000],[7*$mm,7.5*$mm,200000],[7.5*$mm,8*$mm,235000],[8*$mm,8.5*$mm,265000],[8.5*$mm,9*$mm,290000],[9*$mm,10*$mm,345000],[10*$mm,11*$mm,400000],[11*$mm,12*$mm,500000],[12*$mm,13*$mm,650000],[13*$mm,14*$mm,750000],[14*$mm,15*$mm,850000]];foreach($r as $x){if($amount>=$x[0]&&$amount<$x[1])return $x[2];}return 850000;}
function calc_gateway_fee_toman($toman){$fee=(int)round($toman*0.005);if($fee>12000)$fee=12000;if($fee<0)$fee=0;return $fee;}
function get_total($st){$amount=(int)($st['amount']??0);$fee_base=(int)($st['fee_base']??($st['fee']??0));$fee_extra=(int)($st['fee_extra_change']??0);$fee_misc=(int)($st['fee_misc']??0);$kyc=(int)($st['kyc_fee']??0);return $amount+$fee_base+$fee_extra+$fee_misc+$kyc;}
function get_total_with_gateway($st){$base=get_total($st);$gw=0;if(($st['pay_method']??'')==='auto'){$gw=calc_gateway_fee_toman($base);}return $base+$gw;}
function invoice_text($st){global $TXT;$normalize=function($s){$s=trim((string)$s);$s=rtrim($s,":：");return $s;};$title=$normalize($TXT['invoice_title_plain']??'');$header_tpl=$TXT['invoice_header_template']??'';$p_acc=$TXT['invoice_acc_price_plain']??'';$p_fee=$TXT['invoice_fee_plain']??'';$p_kyc=$TXT['invoice_kyc_plain']??'';$p_fb=$TXT['invoice_fbchg_plain']??'';$p_misc=$TXT['invoice_misc_plain']??'';$p_gw=$TXT['invoice_gateway_plain']??'';$t_title=$normalize($TXT['invoice_total_title_plain']??'');$total_heading_tpl=$TXT['invoice_total_heading_template']??'';$total_amount_tpl=$TXT['invoice_total_amount_template']??'';$p_saves=$TXT['invoice_saves_plain']??'';$currency=$TXT['currency_suffix_plain']??'';$gw_notice=$TXT['invoice_gateway_notice']??'';$amount=(int)($st['amount']??0);$fee_base=(int)($st['fee_base']??($st['fee']??0));$kycfee=(int)($st['kyc_fee']??0);$fbchg=(int)($st['fee_extra_change']??0);$misc=(int)($st['fee_misc']??0);$base_total=get_total($st);$gw_fee=(($st['pay_method']??'')==='auto')?calc_gateway_fee_toman($base_total):0;$out=[];if($title!==''){$header=$header_tpl!==''?strtr($header_tpl,['{title}'=>$title]):$title;$out[]=$header;}if($amount>0&&$p_acc!==''){$line='<blockquote><b>'.$p_acc.' '.number_format($amount);if($currency!==''){$line.=' '.$currency;}$line.='</b></blockquote>';$out[]=$line;}if($fee_base>0&&$p_fee!==''){$line='<blockquote><b>'.$p_fee.' '.number_format($fee_base);if($currency!==''){$line.=' '.$currency;}$line.='</b></blockquote>';$out[]=$line;}if($kycfee>0&&$p_kyc!==''){$line='<blockquote><b>'.$p_kyc.' '.number_format($kycfee);if($currency!==''){$line.=' '.$currency;}$line.='</b></blockquote>';$out[]=$line;}if($fbchg>0&&$p_fb!==''){$line='<blockquote><b>'.$p_fb.' '.number_format($fbchg);if($currency!==''){$line.=' '.$currency;}$line.='</b></blockquote>';$out[]=$line;}if($misc>0&&$p_misc!==''){$line='<blockquote><b>'.$p_misc.' '.number_format($misc);if($currency!==''){$line.=' '.$currency;}$line.='</b></blockquote>';$out[]=$line;}if($gw_fee>0&&$p_gw!==''){$line='<blockquote><b>'.$p_gw.' '.number_format($gw_fee);if($currency!==''){$line.=' '.$currency;}$line.='</b></blockquote>';$out[]=$line;}elseif($gw_fee<=0&&$gw_notice!==''){$out[]=$gw_notice;}$final_total=(($st['pay_method']??'')==='auto')?$base_total+$gw_fee:$base_total;if($t_title!==''){$out[]=($total_heading_tpl!==''?strtr($total_heading_tpl,['{title}'=>$t_title]):$t_title);}if($total_amount_tpl!==''){$out[]=strtr($total_amount_tpl,['{amount}'=>number_format($final_total),'{currency}'=>$currency]);}$names=[];if(($st['misc_on']??false)===true){$misc_name=$TXT['save_name_misc']??'';if($misc_name!==''){$names[]=$misc_name;}}else{$kyc=$st['kyc']??[];$map=['act'=>'save_name_act','fb'=>'save_name_fb','gg'=>'save_name_gg'];foreach($map as $code=>$key){if(in_array($code,$kyc)){ $nm=$TXT[$key]??'';if($nm!==''){$names[]=$nm;}}}}if($p_saves!==''&&!empty($names)){$out[]='<blockquote><b>'.$p_saves.' '.implode(' ',$names).'</b></blockquote>';}$text=implode("\n",$out);return $text;}
function invoice_kb($st,$uid,$locked=false){global $BTN;$myack=(($st['amt_acks']??[])&&isset($st['amt_acks'][$uid]));$cb=function($x)use($locked){return $locked?'lock':$x;};return ['inline_keyboard'=>[[['text'=>$myack?$BTN['amt_ok_me_on']:$BTN['amt_ok_me_off'],'callback_data'=>$cb('amt_ok')],['text'=>$BTN['amt_edit'],'callback_data'=>$cb('amt_edit')]]]];}
function parse_start($p){if(preg_match('/^get_([A-Za-z0-9]+)$/',$p,$m))return ['kind'=>'get','token'=>$m[1]];if(preg_match('/^(buyer|seller)_(\-?\d+)_([A-Za-z0-9]+)$/',$p,$m))return ['kind'=>'role','role'=>$m[1],'chat_id'=>$m[2],'token'=>$m[3]];return null;}
function find_chat_by_token($tok){$files=list_plan_files();foreach($files as $f){$a=@json_decode(@file_get_contents($f),true);if(!is_array($a))continue;$lt=$a['link_tokens']??null;if(is_array($lt)){if(($lt['buyer']??'')===$tok)return ['chat_id'=>str_replace(['plan_','.json'],['',''],basename($f)),'role'=>'buyer'];if(($lt['seller']??'')===$tok)return ['chat_id'=>str_replace(['plan_','.json'],['',''],basename($f)),'role'=>'seller'];}}return null;}
function base_url_here(){$scheme=(!empty($_SERVER['HTTPS'])&&$_SERVER['HTTPS']!=='off')?'https':'http';$host=$_SERVER['HTTP_HOST']??'';$path=rtrim(dirname($_SERVER['SCRIPT_NAME']??''),'/');return $scheme.'://'.$host.$path;}
function build_zp_link($cid,$amount_toman,$payer_id){$st=load_state($cid);$base_total=is_array($st)?(int)($st['total']??get_total($st)):(int)$amount_toman;$gw_fee=calc_gateway_fee_toman($base_total);$pay_toman=$base_total+$gw_fee;if(is_array($st)){$st['pay_method']='auto';$st['gateway_fee']=$gw_fee;$st['total_with_gateway']=$pay_toman;save_state($cid,$st);}ensure_dir();$ordersFile=data_dir().'/zp_orders.json';$orders=@json_decode(@file_get_contents($ordersFile),true);if(!is_array($orders))$orders=[];$code=bin2hex(random_bytes(6));$orders[$code]=['cid'=>$cid,'payer'=>$payer_id,'amount_toman'=>$pay_toman,'gateway_fee'=>$gw_fee,'created'=>time()];@file_put_contents($ordersFile,json_encode($orders,JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),LOCK_EX);$amount_rial=$pay_toman*10;$base=base_url_here();$url=$base.'/zp_req.php?chat_id='.rawurlencode((string)$payer_id).'&amount='.$amount_rial;return ['ok'=>true,'url'=>$url,'code'=>$code,'toman'=>$pay_toman,'gateway_fee'=>$gw_fee];}
function admin_flags_path(){ensure_dir();return data_dir().'/admin_flags.json';}
function admin_flags_all(){
$path=admin_flags_path();
if(file_exists($path)){
$json=file_get_contents($path);
$data=json_decode($json,true);
if(is_array($data))return $data;
}
return [];
}
function admin_flags_save(array $flags){
if(!$flags){
$path=admin_flags_path();
if(file_exists($path))@unlink($path);
return;
}
file_put_contents(admin_flags_path(),json_encode($flags,JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),LOCK_EX);
}
function admin_flags_is_disabled($name){$flags=admin_flags_all();return (bool)($flags[$name]??false);}
function admin_flags_toggle($name){$flags=admin_flags_all();$current=(bool)($flags[$name]??false);$disabled=!$current;if($disabled){$flags[$name]=true;}else{unset($flags[$name]);}$path_flags=$flags;admin_flags_save($path_flags);return ['flags'=>$path_flags,'disabled'=>$disabled];}
